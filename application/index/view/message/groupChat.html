<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no" />    
	<script src="__STATIC__/chatWeb/js/public/rem.js"></script>    
    <link rel="stylesheet" href="__STATIC__/chatWeb/css/public/public.css">
    <link rel="stylesheet" href="__STATIC__/chatWeb/css/public/public_head.css">
    <link rel="stylesheet" href="__STATIC__/chatWeb/css/news/group.css">
    <link rel="stylesheet" href="__STATIC__/chatWeb/css/news/givered.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/chatWeb/css/news/red_details.css">
    <link rel="stylesheet" href="__STATIC__/chatWeb/css/news/jquery.sinaEmotion.css">
    <title>群聊</title>
</head>

<body onload="connect();">
    <div class="wrap_frame">
        <!--public head-->
        <div class="lb_headWrap">
            <p class="lb_headWrap_return" data-num="1" onclick="returnFun()">
                <img class="lb_headWrap_return_img" src="__STATIC__/chatWeb/img/public/left.png"/>
            </p>
            <p class="lb_headWrap_dialog">
                <!-- <span class="lb_headWrap_dialog_text">999</span> -->
            </p>
            <span>{$data['name']}</span>
            <p class="lb_headWrap_remove" onclick="window.location.href='/index/groupchat/groupSet'">
                <img class="lb_headWrap_remove_img" src="__STATIC__/chatWeb/img/news/group.png">
            </p>
        </div>
     <!--    <div class="group_notice">
            <div class="group_notice_imgwrap">
                <img class="group_notice_img" src="__STATIC__/chatWeb/img/news/notice.png" alt="">
            </div>
            <div class="group_notice_text">
                公告维护中
            </div>
        </div> -->
        <!-- 群聊内容 -->
        <div class="group_content">
            <!-- <div class="group_content_time">
                周日 17:24
            </div> -->
            <!-- 对方发红包 -->
           
            <!-- 领取红包提示 -->
            <!-- <div class="group_content_tips">
                <p class="group_content_tips_text">
                    <img class="group_content_tips_img" src="__STATIC__/chatWeb/img/news/tips.png" alt="">
                    霜之哀伤领取了你的<span class="group_content_tips_strong">红包</span>
                </p>
            </div> -->
            <!-- 领取红包提示 -->
            <!-- <div class="group_content_tips">
                <p class="group_content_tips_text">
                    <img class="group_content_tips_img" src="__STATIC__/chatWeb/img/news/tips.png" alt="">
                    小火汁领取了你的<span class="group_content_tips_strong">红包</span>
                </p>
            </div> -->
            <!-- 自己发红包 -->
          
            <!-- 红包弹出框 -->
            <div class="group_packwrap">
                <div class="group_pack">
                    <div class="group_pack_title">
                        <img class="group_pack_img" src="" alt="">
                        <span>来自<span class="from_nickname"></span>的红包</span>
                    </div>
                    <div class="group_pack_state">
                         
                    </div>
                    <div class="group_pack_num">
                        ￥<span class="get_red_money"></span>元
                    </div>
                    <div class="group_pack_title get_award" style="display:none">
                            奖励：<span class="award_money"></span>元
                    </div>
                    <div class="group_pack_info" data-red-id="">
                        查看领取详情
                    </div>
                </div>
            </div>
            
            <!-- 底部菜单 -->
            <div class="group_menu">
                <div class="group_menu_inputwrap clearfloat">
                    <div class="group_menu_voice">
                            <img class="group_menu_img" src="__STATIC__/chatWeb/img/news/voice.png" alt="">
                        </div>
                        <label class="group_menu_label">
                            <!-- <div class="group_menu_input" contenteditable="true"></div> -->
                            <input class="group_menu_input" type="text" placeholder="禁言中" disabled="disabled">
                        </label>
                        <span class="group_menu_send">发送</span>
                    </div>
                    <div class="group_menu_submenu">
                        <p class="group_menu_submenu_item" onclick="window.location.href='/index/recharge/index.html'">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/recharge.png" alt="">
                            <span>充值</span>
                        </p>
                        <p class="group_menu_submenu_item" onclick="window.location.href='/index/my/myBill/bill.html'">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/bill.png" alt="">
                            <span>账单</span>
                        </p>
                        <p class="group_menu_submenu_item givered_7">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/snatch_7.png" alt="">
                            <span>7个红包</span>
                        </p>
                        <p class="group_menu_submenu_item givered_9">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/snatch_9.png" alt="">
                            <span>9个红包</span>
                        </p>
                        <p class="group_menu_submenu_item">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/smile.png" alt="">
                            <span>表情</span>
                        </p>
                        <p class="group_menu_submenu_item" onclick="window.location.href='/index/recharge/tixian.html'">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/withdraw.png" alt="">
                            <span>提现</span>
                        </p>
                        <p class="group_menu_submenu_item" onclick="window.location.href='{$group_owner_chat_url}'">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/owner.png" alt="">
                            <span>群主</span>
                        </p>
                        <p class="group_menu_submenu_item">
                            <img class="group_menu_submenu_img" src="__STATIC__/chatWeb/img/news/picture.png" alt="">
                            <span>图片</span>
                        </p>
                    </div>
                    <div class="group_menu_more">
                        <img class="group_menu_more_img" src="__STATIC__/chatWeb/img/news/more.png" alt="">
                    </div>
                </div>
            </div>
            <!-- 领取详情 -->
            <div class="red_details clearfloat">
                <div class="wrap_frame">
                    <!--public head-->
                    <div class="headWrap">
                        <p class="lb_headWrap_return">
                            <img class="lb_headWrap_return_img" src="__STATIC__/chatWeb/img/public/left.png"/> 
                        </p>
                        <span>红包详情</span>
                    </div>
                    <!--内容-->
                    <div class="content">
                        <div class="top_wrap">
                            <!---->
                            <div class="top">
                                <!--金额-->
                                <div class="money">
                                    <span class="com">共</span>
                                    <span class="sum"></span>
                                    <span class="com">元</span>
                                </div>
                            </div>
                            <!---->
                            <div class="middle">
                                <!--半圆背景-->
                                <div class="oval"></div>
                                <!--头像-->
                                <div class="photo">
                                    <img src="" class="photo_head"/>
                                </div>
                                <!--名称-->
                                <div class="name"></div>
                            </div>
                            <!--领取红包数-->
                            <div class="get_wrap">
                                <!--红包数说明-->
                                <div class="account">
                                    <div class="rece">
                                        <span>已领取</span>
                                        <span><span class="get_ok"></span>/<span class="total_num"></span></span>
                                        <span>共</span>
                                        <span class="red_total"></span>
                                    </div>
                                    <div class="ray">
                                        <span>雷点：</span>
                                        <span class="ray_points"></span>
                                    </div>
                                </div>
                                <!--领取红包详细-->
                                <div class="info_wrap">
                                    <!--未中雷状态-->
                                    <!-- <div class="item">
                                        <div class="img">
                                            <img src="__STATIC__/chatWeb/img/0009g.png" />
                                        </div>
                                        <div class="name_time">
                                            <div class="super">超级靓子</div>
                                            <p class="time">
                                                <span>2019-04-09</span>
                                                <span>23:02:45</span>
                                            </p>
                                        </div>
                                        <div class="right_sum">
                                            <p class="fig">50.00元</p>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                    </div>
                   </div>
            </div>
            <!-- 发红包 -->
            <div class="give_pack clearfloat">
                <div class="wrap_frame">
                    <!--public head-->
                    <div class="headWrap">
                        <p class="lb_headWrap_return">
                            <img class="lb_headWrap_return_img" src="__STATIC__/chatWeb/img/public/left.png" />
                        </p>
                        <span>发红包</span>
                    </div>
                    <!--内容-->
                    <div class="content">
                        <div class="middle">
                            <!--红包个数-->
                            <div class="pdt">
                                <div class="nitems">红包个数</div>
                                <div class="inp_wrap">
                                    <input class="text num" type="number" placeholder="" readonly="readonly" />
                                    <span>个</span>
                                </div>
                            </div>
                            <!--总金额-->
                            <div class="pdt">
                                <div class="nitems">总金额</div>
                                <div class="inp_wrap">
                                    <input class="text red_money price" type="number" maxlength="3" onkeyup="this.value = this.value.match(/^\d+\.?\d{0,2}/)" onkeyup='this.value=this.value.replace(/[^0-9.]/g,"")' placeholder="红包范围{$data['min_money']}-{$data['max_money']}" />
                                    <span>元</span>
                                </div>
                            </div>
                            <!--雷点选择-->
                            <div class="select">
        
                                <div class="dot">
                                    <span>雷点选择</span>
                                    <span></span>
                                </div>
                                <div class="ray_wrap">
                                    <ul>
                                        <li class="rob">0</li>
                                        <li>1</li>
                                        <li>2</li>
                                        <li>3</li>
                                        <li>4</li>
                                        <li class="rob">5</li>
                                        <li>6</li>
                                        <li>7</li>
                                        <li>8</li>
                                        <li>9</li>
                                    </ul>
                                </div>
        
                            </div>
                            <!--雷点说明-->
                            <div class="state">多雷请选择多个数字，游戏倍数<span class="rule_set">0</span></div>
                            <!--发红包按钮-->
                            <div class="give_btn" data-key="{$key}">
                                <a class="btn">发红包</a>
                            </div>
        
                            <!--(数字-键盘)底部弹窗（蒙版）body-->
                            <div class="bottom_alert_wrap">
                                <div class="mask_text">
                                    <div class="red_envelope">
                                        红包
                                        <p class="delete_img_box">
                                            <img class="delete_img" src="__STATIC__/chatWeb/img/news/delete_icon.png" alt="" />
                                        </p>
                                        
                                    </div>
                                    <p class="red_envelope_money">￥<span class="red_money"></span></p>
                                    <div class="ds">
                                        <div class="ds_ds">
                                            <div class="dsds_item">
                                                <p class="dsds_item_icon_box">
                                                    <img src="__STATIC__/chatWeb/img/news/qian.png" class="tixian_pic" />
                                                </p>
                                                <span class="qunliao_item_text">账号余额(<span class="now_account">{$user['account']}</span>元)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="password_box">
                                        <p class="password_box_num"><span class="trem_box">·</span></p>
                                        <p class="password_box_num"><span class="trem_box">·</span></p>
                                        <p class="password_box_num"><span class="trem_box">·</span></p>
                                        <p class="password_box_num"><span class="trem_box">·</span></p>
                                        <p class="password_box_num"><span class="trem_box">·</span></p>
                                        <p class="password_box_num"><span class="trem_box">·</span></p>
                                    </div>
                                </div>
                                
                                
                                <!--输入完密码 => 遮罩层-->
                               
                                
                                <!--底部弹窗（框）-->
                                <div class="bottom_alert_box">
                                    <!--数字键盘-->
                                    <div class="digital_keyboard_box">
                                        <!--data-num:下标-->
                                        <p class="number_trem digital_key" data_state="true">1</p>
                                        <p class="number_trem digital_key" data_state="true">2</p>
                                        <p class="number_trem digital_key" data_state="true">3</p>
                                        <p class="number_trem digital_key" data_state="true">4</p>
                                        <p class="number_trem digital_key" data_state="true">5</p>
                                        <p class="number_trem digital_key" data_state="true">6</p>
                                        <p class="number_trem digital_key" data_state="true">7</p>
                                        <p class="number_trem digital_key" data_state="true">8</p>
                                        <p class="number_trem digital_key" data_state="true">9</p>
                                        <!--最后三个无bottom边框-->
                                        <p class="number_trem number_trem_none"></p>
                                        <p class="number_trem number_trem_none digital_key" data_state="true">0</p>
                                        <div class="number_trem number_trem_none">
                                            <i class="eliminate_cion"></i>
                                            <!--删除按钮-->
                                            <p class="delete_box digital_key" data-state="delete"></p>
                                        </div>
                                    </div>
                                </div>
        
                            </div>
        
                            <!--红包说明-->
                            <div class="state">未领取的红包，将5分钟后退款</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 放大后的图片 -->
            <div class="magnify_mask">
                <img class="magnify" src="" onerror="onerror=null;src='__STATIC__/chatWeb/img/news/load.gif'" alt="">
            </div>
    </div>
    <audio id="audio">
        <source src="__STATIC__/chatWeb/img/news/tips.mp3">
    </audio>
    {include file="common/footer_js"}
    <script src="__STATIC__/chatWeb/js/news/jquery.sinaEmotion.js"></script>
    <script src="__STATIC__/chatWeb/js/news/group.js"></script>
    <script>

        // ws begin
        var API_URL = "/index.php/api/chat/"; // 请求地址
        var fromid  = {$user.id};
        var from_head  = "{$user.head_imgurl}";    // 当前用户头像
        var from_name =  "{$user.nickname}";  // 当前用户昵称
        var room_id = {$data.id};
        var group_name = "{$data.name}";
        var min_money = {$data.min_money};
        var max_money = {$data.max_money};
        var send_key = "{$send_key}";
        // 10的倍数
        var multiple = 10;

        // 设置赔率
        var ponit_7_one = {$rule_set.thunder_7_one.value};
        var ponit_9_one = {$rule_set.thunder_9_one.value};
        var ponit_9_two = {$rule_set.thunder_9_two.value};
        var ponit_9_three = {$rule_set.thunder_9_three.value};
        var ponit_9_four = {$rule_set.thunder_9_four.value};
        var ponit_9_five = {$rule_set.thunder_9_five.value};

        // 连接服务端
        function connect() {
            console.log('连接群聊服务端1');
            // 创建全局websocket
            ws =  new WebSocket("ws://47.107.185.253:8282");
            // 当socket连接打开时
            ws.onopen = login;
            // 当有消息时根据消息类型显示不同信息

            ws.onmessage = onmessage;
            ws.onclose = function() {
                console.log("连接关闭，定时重连...");
                connect();
            };
            ws.onerror = function() {
                console.log("出现错误");
            };
        }
    
        function login(){
            console.log('发送登录到ws');
            // 登录
            var login_data = '{"type":"login","fromid":'+fromid+',"room_id":'+room_id+',"group_name":"'+group_name.replace(/"/g, '\\"')+'"}';
            console.log("websocket握手成功，发送登录数据:"+login_data);
            ws.send(login_data);
            red_list_load();
        }

        // 服务端发来消息时,根据业务类型type处理客户端页面相应业务
        function onmessage(e){

            console.log(e.data);
            var message = eval("("+ e.data+")");    
            switch (message.type){
                // 服务端ping客户端
                case 'ping':
                    ws.send('{"type":"pong"}');
                    break;
                // 进入群页面
                case "in_group_chat":
                    console.log('已进入红包群');
                    return;

                // 用户获得奖励群通知
                case "get_award_notice":
                    if(room_id == message.room_id && fromid != message.from_id) {
                        let str ='';
                            str += '<div class="group_content_tips">'
                                +  '<p class="group_content_tips_text">'
                                +  '<span class="group_award_title">'
                                +  '<img class="group_content_tips_img" src="__STATIC__/chatWeb/img/news/tips.png">'
                                +  message.from_name+'获得奖励</span><span class="group_content_tips_strong">'+message.award_money+'</span>'
                                +  '</p></div>'
                        $('.group_content').append(str);
                    }
                    return;
                
                // 领取红包通知
                case "get_red_notice":
                    console.log(fromid);
                    console.log(message.from_id);
                    if(room_id == message.room_id && fromid == message.from_id) {
                        let str ='';
                            str += '<div class="group_content_tips">'
                                +  '<p class="group_content_tips_text">'
                                +  '<span class="group_award_title">'
                                +  '<img class="group_content_tips_img" src="__STATIC__/chatWeb/img/news/tips.png">'
                                +  message.from_name+'领取了你的<span class="group_content_tips_strong">红包</span>'
                                +  '</p></div>'
                        $('.group_content').append(str);
                    }
                    return;

                case "get_group_red":
                    // 接收对方红包推送
                    if(room_id == message.room_id && fromid != message.fromid) {
                        let str = '';
                        str += '<div class="group_content_opposite clearfloat open_red" data-m-id="'+message.red_id+'">'
                            + '<div class="group_content_opposite_imgwrap">'
                            + '<img class="group_content_opposite_img" src='+message.from_head+'>'
                            + '</div>'
                            + '<div class="group_content_opposite_info">'
                            + '<p class="group_content_opposite_name">'+message.from_name+'</p>'
                            + '<div class="group_content_opposite_pack">'
                            + '<img class="group_content_opposite_img" src="__STATIC__/chatWeb/img/news/pack.png">'
                            + '<div class="pack_titie">拆</div>'
                            + '<div class="pack_num">'
                            + '<p>恭喜发财</p>'
                            + '<p>'+message.red_money+'/'+message.ray_point+'</p>'
                            + '</div>'
                            + '<div class="pack_state">'
                            + '未拆开'
                            + '</div></div></div></div>'
                        $('.group_content').append(str);
                        $('html, body').animate({
                            scrollTop: $('html, body').height()
                        }, 'slow');
                        $('#audio')[0].play();
                        if (navigator.vibrate) {
                            navigator.vibrate([200,50,200]);
                        } else if (navigator.webkitVibrate) {
                            navigator.webkitVibrate([200,50,200]);
                        }
                    }
                    return;
            }
        }

        $(function() {
            /**
             * 全局变量
             * **/
            /*存储-当前滚动条的位置*/
            var thisScroll_num = null;
            /*获取支付密码（后台*/
            var pass_val = '';
            /*雷点-选择*/
            let num = 1;
            $(".ray_wrap ul li").click(function() {
                var red_num = $('.num').val();
                if(red_num == 7){
                    var set_point = 1;
                    $('.rule_set').html(ponit_7_one);
                }else{
                    var set_point = 5;
                    $('.rule_set').html(ponit_9_one);
                }
                $(".ray_wrap ul li").each(function(){
                    if($(this).hasClass('active')){
                        num++;
                    }
                })
                let sum = 0;
                // 7为最大选择数量
                if(set_point==1){
                    $(".ray_wrap ul li").each(function(){
                        if($(this).hasClass('active')){
                            sum++;
                        }
                    })
                    if(sum <= set_point&&sum != 0){
                        $(this).siblings('.ray_wrap ul li').removeClass('active');
                        if(!$(this).hasClass('active')){
                            $(this).addClass('active');
                            $('.rule_set').html(ponit_7_one);
                        }else{
                            $('.rule_set').html(0);
                            $(this).removeClass('active');
                        }
                    }else{
                        $('.rule_set').html(ponit_7_one);
                        $(this).siblings('.ray_wrap ul li').removeClass('active'); // 删除其他兄弟元素的样式
                        $(this).addClass('active'); // 添加当前元素的样式
                    }
                }
                if(set_point==5){
                    if(num <= set_point){
                        if(!$(this).hasClass('active')){
                            $(this).addClass('active');
                        }else{
                            $(this).removeClass('active');
                        }
                        $(".ray_wrap ul li").each(function(){
                            if($(this).hasClass('active')){
                                sum++;
                            }
                        })
                        if(sum == 0){
                            $('.rule_set').html('0'); 
                        }else if(sum == 2){
                            $('.rule_set').html(ponit_9_two); 
                        }else if(sum == 3){
                            $('.rule_set').html(ponit_9_three); 
                        }else if(sum == 4){
                            $('.rule_set').html(ponit_9_four); 
                        }else if(sum >= 5){
                            $('.rule_set').html(ponit_9_five); 
                        }
                    }else{
                        $(this).removeClass('active');
                        $(".ray_wrap ul li").each(function(){
                            if($(this).hasClass('active')){
                                sum++;
                            }
                        })
                        if(sum == 0){
                            $('.rule_set').html('0'); 
                        }else if(sum == 2){
                            $('.rule_set').html(ponit_9_two); 
                        }else if(sum == 3){
                            $('.rule_set').html(ponit_9_three); 
                        }else if(sum == 4){
                            $('.rule_set').html(ponit_9_four); 
                        }else if(sum >= 5){
                            $('.rule_set').html(ponit_9_five); 
                        }
                    }
                }
                num = 1;
            });
            // 发红包
            ray_point = '';
            /*点击发红包出现-底部弹窗*/
            $('.give_btn').on('click',function(){
                
                var red_num = $('.num').val();
                var red_money = $('.red_money').val();
                var key = $('.give_btn').attr('data-key');
                if(!red_num){
                    layer.msg('红包个数有误');return;
                }
                if(!red_money){
                    layer.msg('红包金额'+min_money+'-'+max_money);return;
                }
                if(!room_id){
                    layer.msg('群内异常,稍后再试');return;
                }
                // 判断金额是否在范围内
                if(red_money >= min_money && red_money <= max_money && red_num){
                    
                    // if(red_money%multiple != 0){
                    //     layer.msg('红包金额'+min_money+'-'+max_money+'('+multiple+'的倍数)');return;
                    // }
                    if(!key){
                        layer.msg('缺少参数:key');return;
                    }
                    // 填充发红包金额
                    $('.red_money').html(red_money);
                    let arr=[];
                    $(".ray_wrap ul li").each(function(){
                        if($(this).hasClass('active')){
                            arr.push($(this).html());
                        }
                    })
                    ray_point = arr;
                    $('.bottom_alert_wrap').show();
                    /*底部弹窗(出现)*/
                    $('.bottom_alert_box').animate({'bottom':'0'})
                    /*获取当前滚动条的位置*/
                    thisScroll_num = $(document).scrollTop();
                    // console.log('获取当前滚动条的位置',thisScroll_num);
                    /**禁止底部滑动
                     * 设置为fixed之后会飘到顶部，所以要动态计算当前用户所在高度
                     **/
                    $('.wrap').css({
                        'position':'fixed',
                        'top': -thisScroll_num,
                        'left': 0,
                    });
                }else{
                    // layer.msg('红包金额'+min_money+'-'+max_money+'('+multiple+'的倍数)');return;
                    layer.msg('红包金额'+min_money+'-'+max_money);return;
                }
            })

            /*000*/
            $('.digital_key').on('click',function(){
                /*触摸-添加样式*/
                $(this).addClass('number_trem_active');
                /*当前的元素*/
                var this_eve = $(this);
                /*当前的数字*/
                var this_nun = Number(this_eve.html());
                /*当前-状态(输入数字true，删除false)*/
                var this_state = true;
                /*删除-按钮*/
                if(this_eve.attr('data-state') == 'delete'){
                    /*如果当元素为空时*/
                    if(pass_val == ""){
                        remove_class($(this));
                        return false;
                    }
                    /*删除最后一个元素*/
                    arr_str = pass_val.split('');
                    /*数组删除最后一项*/
                    arr_str.pop();
                    pass_val = arr_str.join('');
                        //if(pass_val.length){
                    // console.log('模拟删除代码',pass_val.length);
                    /*页面-模拟删除代码*/
                    if(pass_val.length > 0){
                        $('.password_box_num .trem_box').eq(pass_val.length).removeClass("show_box");
                    }else {
                        $('.password_box_num .trem_box').eq(0).removeClass("show_box");
                    }
                    this_state = false;
                }
                /*获取支付密码*/
                if(pass_val.length < 6 && this_state){
                    pass_val += this_nun;
                }
                /*状态*/
                if(this_state){
                    /*页面-模拟密码-代码*/
                    $('.password_box_num .trem_box').eq(pass_val.length-1).addClass("show_box");
                }
                /*密码长度为6时，ajax*/
                if(pass_val.length == 6){
                    remove_class($(this));
                    var red_num = $('.num').val();
                    var red_money = $('.red_money').val();
                    var key = $('.give_btn').attr('data-key');
                    // console.log(ray_point);
                    // 验证密码提交数据
                    $.post("/index/groupchat/groupSendRed",
                        {"room_id":room_id, "red_num":red_num, "red_money":red_money, "ray_point":ray_point, "pwd":pass_val, "key":key},
                        function(msg){
                        if(msg.code==1){

                            // 必须返回红包id
                            var red_id = msg.data.red_id; // 数据库返回来
                            if(red_id){

                                // 请空输入的金额和雷点
                                $(".ray_wrap ul li").removeClass('active');
                                $('.give_pack').hide(); // 隐藏红包div
                                $('.red_money').val('');
                                $('body').css('padding-bottom','1.4rem')
                                $('.group_content').show();
                                if(ray_point){
                                    ray_point = ray_point.join(',');//数组转成为字符串
                                }
                            
                                $('.bottom_alert_wrap').hide();
                                pass_val='';
                                $('.trem_box').removeClass('show_box');

                                let str = '';
                                    str +=  '<div class="dialog_content_oneself clearfloat open_red"  open_red" data-m-id="'+red_id+'">'
                                        +   '<div class="group_content_oneself clearfloat">'
                                        +   '<div class="group_content_oneself_imgwrap">'
                                        +   '<img class="group_content_oneself_img" src="'+from_head+'">'
                                        +   '</div>'
                                        +   '<div class="group_content_oneself_info">'
                                        +   '<p class="group_content_oneself_name">'+from_name+'</p>'
                                        +   '<div class="group_content_oneself_pack">'
                                        +   '<img class="group_content_oneself_img" src="__STATIC__/chatWeb/img/news/pack.png">'
                                        +   '<div class="pack_titie">拆</div>'
                                        +   '<div class="pack_num">'
                                        +   '<p>恭喜发财</p>'
                                        +   '<p>'+red_money+'/'+ray_point+'</p>'
                                        +   '</div>'
                                        +   '<div class="pack_state">'
                                        +   '未拆开'
                                        +   '</div></div></div></div>'
                                    $('.group_content').append(str);
                                    $('html, body').animate({
                                        scrollTop: $('html, body').height()
                                    }, 'slow');

                                // 推送给当前群所有在线用户
                                var message = '';
                                    message += '{"red_id":"'+red_id+'",'
                                            + '"red_num":"'+red_num+'",'
                                            + '"type":"send_group_red",'
                                            + '"fromid":"'+fromid+'",'
                                            + '"room_id":"'+room_id+'",'
                                            + '"from_head":"'+from_head+'",'
                                            + '"from_name":"'+from_name+'",'
                                            + '"red_money":"'+red_money+'",'
                                            + '"ray_point":"'+ray_point+'",'
                                            + '"send_key":"'+send_key+'"}'
                                ws.send(message); // 向服务器发送信息
                                // 更新余额到页面
                                $.post("/index/my/getAccount",{uid:fromid},function(msg){
                                    $('.now_account').html(msg.data.account);
                                });
                            }else{
                                layer.msg('网络异常,稍后再试');
                            }
                        }else if(msg.code==101){
                            layer.confirm(msg.msg, {
                            btn: ['设置','取消'], skin: 'layer-custom', title: '提示', closeBtn:0,icon:4
                                }, function(){
                                    console.log(11);
                                    window.location.href = '/index/recharge/paypwd';
                                }, function(){
                                    $('.delete_img_box').trigger("click");
                                    layer.closeAll('dialog');
                                    return false;
                                });
                        }else{
                            layer.msg(msg.msg);
                            $('.mask_text').show();
                            $('.bottom_alert_box').show();
                            pass_val='';
                            $('.trem_box').removeClass('show_box');
                            return false;
                        }
                    },'json')
                    return false;
                }
                remove_class($(this));
            })
            /*离开-删除样式*/
            function remove_class(_this){
                /*模拟-touchs事件，因为iso上失效*/
                setTimeout(function(){
                    _this.removeClass('number_trem_active');
                },100);
                
            }
            /*关闭遮罩层*/
            $('.delete_img_box').on('click',function(){
                 $('.bottom_alert_wrap').hide();
                 pass_val='';
                 $('.trem_box').removeClass('show_box');
                /*底部弹窗(隐藏)*/
                $('.bottom_alert_box').animate({'bottom':-($('.bottom_alert_box').height())});
                /*恢复底部滑动*/
                $('.wrap').css({
                    'position':'',
                    'top': '',
                    'left': '',
                });
                // console.log(66666,thisScroll_num);
                /*恢复当前用户滚动的位置！*/
                $(document).scrollTop(thisScroll_num);
                
            })
        });

        function num(obj){
            obj.value = obj.value.replace(/[^\d.]/g,""); //清除"数字"和"."以外的字符
            obj.value = obj.value.replace(/^\./g,""); //验证第一个字符是数字
            obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个, 清除多余的
            obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
            obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3'); //只能输入两个小数
        }

        // 抢红包
        $('.group_content').on('click','.open_red',function(){
            var red_id = $(this).attr('data-m-id');
            var key = $('.give_btn').attr('data-key');
            var that = $(this);
            if(!red_id || !key){
                layer.msg('缺失参数-');return;
            }
            $.post("/index/groupchat/openToRed",{"room_id":room_id,"red_id":red_id,"key":key},function(msg){
                if(msg.code == 1 ){
                    console.log(msg);
                    $('.group_packwrap').show();
                    $('.group_pack_state').html(msg.data.is_die_flag);
                    $('.get_red_money').html(msg.data.get_red_money);
                    $('.from_nickname').html(msg.data.from_name);
                    $(".group_pack_img").attr("src", msg.data.from_head);
                    $(that).find(".pack_state").html('已拆开');
                    $(that).find(".group_content_opposite_pack .group_content_opposite_img,.group_content_oneself_pack .group_content_oneself_img").attr('src',"__STATIC__/chatWeb/img/news/pack1.png");
                    $(".group_pack_info").attr("data-red-id", msg.data.red_id);
                    if(msg.data.get_award_money!=0){
                        $('.get_award').show();
                        $('.award_money').html(msg.data.get_award_money);
                        // 群发获得奖励通知到当前群
                        var get_award_data = '{"type":"send_award_notice","from_id":"'+msg.data.from_id+'","from_name":"'+from_name+'","room_id":"'+room_id+'","award_money":"'+msg.data.get_award_money+'"}';
                        ws.send(get_award_data);
                    }
                    // 自己领取不推送
                    if(msg.data.from_id != fromid){
                        // 推送领红包信息到发红包用户
                        var get_red_data = '{"type":"send_get_red_notice","from_id":"'+msg.data.from_id+'","from_name":"'+from_name+'","room_id":"'+room_id+'"}';
                        ws.send(get_red_data);
                    }
                   
                }else if(msg.code == 101){
                    $('.group_packwrap').show();
                    $('.group_pack_state').html(msg.data.master_info.is_die_flag);
                    $('.get_red_money').html(msg.data.master_info.get_red_money);
                    $('.from_nickname').html(msg.data.master_info.nickname);
                    $(".group_pack_img").attr("src", msg.data.master_info.head_imgurl);
                    $(that).find(".pack_state").html('已拆开');
                    $(that).find(".group_content_opposite_pack .group_content_opposite_img,.group_content_oneself_pack .group_content_oneself_img").attr('src',"__STATIC__/chatWeb/img/news/pack1.png");
                    $(".group_pack_info").attr("data-red-id", msg.data.master_info.id);
                    if(msg.data.master_info.get_award_money!=0){
                        $('.get_award').show();
                        $('.award_money').html(msg.data.master_info.get_award_money);
                    }
                }else if(msg.code == '-1'){
                    layer.msg(msg.msg,function(){
                        $(that).find(".pack_state").html('已过期');
                        $(that).find(".group_content_opposite_pack .group_content_opposite_img,.group_content_oneself_pack .group_content_oneself_img").attr('src',"__STATIC__/chatWeb/img/news/pack1.png");
                        // $(".group_pack_info").trigger("click");
                    });
                    return;
                }else{
                    layer.msg(msg.msg);
                    return;
                }
            },'json')
        });


        // 加载5分钟内的红包list
        function red_list_load(){
            $.post(
                API_URL +"getRedList",
                {"room_id":room_id},
                function(e){
                    console.log(e);
                    console.log('load 红包');
                    $.each(e,function(index,content){
                        // 当前登录用户发送的放右边 
                        if(fromid==content.uid){ 
                            let str = '';
                            str +=  '<div class="dialog_content_oneself clearfloat open_red"  open_red" data-m-id="'+content.id+'">'
                                +   '<div class="group_content_oneself clearfloat">'
                                +   '<div class="group_content_oneself_imgwrap">'
                                +   '<img class="group_content_oneself_img" src="'+from_head+'">'
                                +   '</div>'
                                +   '<div class="group_content_oneself_info">'
                                +   '<p class="group_content_oneself_name">'+from_name+'</p>'
                                +   '<div class="group_content_oneself_pack">'
                                +   '<img class="group_content_oneself_img" src="__STATIC__/chatWeb/img/news/pack.png">'
                                +   '<div class="pack_titie">拆</div>'
                                +   '<div class="pack_num">'
                                +   '<p>恭喜发财</p>'
                                +   '<p>'+content.money+'/'+content.ray_point+'</p>'
                                +   '</div>'
                                +   '<div class="pack_state">'
                                +   '未拆开'
                                +   '</div></div></div></div>'
                            $('.group_content').append(str);
                        }else{
                            // 页面左边
                            let str = '';
                            str += '<div class="group_content_opposite clearfloat open_red" data-m-id="'+content.id+'">'
                                + '<div class="group_content_opposite_imgwrap">'
                                + '<img class="group_content_opposite_img" src='+content.head_imgurl+'>'
                                + '</div>'
                                + '<div class="group_content_opposite_info">'
                                + '<p class="group_content_opposite_name">'+content.nickname+'</p>'
                                + '<div class="group_content_opposite_pack">'
                                + '<img class="group_content_opposite_img" src="__STATIC__/chatWeb/img/news/pack.png">'
                                + '<div class="pack_titie">拆</div>'
                                + '<div class="pack_num">'
                                + '<p>恭喜发财</p>'
                                + '<p>'+content.money+'/'+content.ray_point+'</p>'
                                + '</div>'
                                + '<div class="pack_state">'
                                + '未拆开'
                                + '</div></div></div></div>'
                            $('.group_content').append(str);
                        }
                    })
                },'json'
            );
        }

    </script>
</body>
</html>